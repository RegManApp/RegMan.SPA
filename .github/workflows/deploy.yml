name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "public/**"
      - "scripts/**"
      - "index.html"
      - "package.json"
      - "package-lock.json"
      - "vite.config.*"
      - "tailwind.config.*"
      - "postcss.config.*"
      - ".github/workflows/deploy.yml"
  pull_request:
    branches:
      - main
    paths:
      - "src/**"
      - "public/**"
      - "scripts/**"
      - "index.html"
      - "package.json"
      - "package-lock.json"
      - "vite.config.*"
      - "tailwind.config.*"
      - "postcss.config.*"
      - ".github/workflows/deploy.yml"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      deployments: write
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL (JavaScript/TypeScript)
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

      - name: Perform CodeQL Analysis
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository }}
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

      - name: Setup Python (Semgrep)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Semgrep
        run: python -m pip install --upgrade pip semgrep

      - name: Run Semgrep (p/ci)
        run: semgrep --config p/ci --json --metrics=off --exclude node_modules --exclude dist . > semgrep.json

      - name: Fail on High/Critical (Semgrep ERROR)
        run: |
          python - <<'PY'
          import json
          import sys

          with open('semgrep.json', 'r', encoding='utf-8') as f:
            data = json.load(f)

          results = data.get('results', []) or []
          errors = [
            r for r in results
            if (r.get('extra', {}).get('severity') or '').upper() == 'ERROR'
          ]

          print(f"Semgrep findings: {len(results)} total, {len(errors)} ERROR")
          if errors:
            for r in errors[:20]:
              msg = (r.get('extra', {}).get('message') or r.get('check_id') or 'Semgrep finding')
              path = r.get('path')
              start = (r.get('start') or {}).get('line')
              end = (r.get('end') or {}).get('line')
              print(f"- {path}:{start}-{end}: {msg}")
            sys.exit(1)
          PY

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=regmanapp
